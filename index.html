<!doctype html>
<html lang="ja" data-theme="light">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>webdiff</title>
    <meta name="description" content="Minimal in-browser text diff tool for instant comparison" />

    <!-- jsdiff -->
    <script src="https://cdn.jsdelivr.net/npm/diff@5.2.0/dist/diff.min.js"></script>

    <style>
        :root {
            --bg: #f4f6f8;
            --panel: #ffffff;
            --border: #c8d1dc;
            --text: #111827;
            --muted: #5b6675;

            --add-bg: #dff7e7;
            --del-bg: #ffe0e0;
            --add-bd: #1f8f3a;
            --del-bd: #c5222b;
            --same-bg: transparent;

            --guide: rgba(17, 24, 39, 0.06);

            --focus: rgba(37, 99, 235, 0.22);
            --accent: #2563eb;

            --shadow: 0 1px 0 rgba(17, 24, 39, 0.03), 0 8px 24px rgba(17, 24, 39, 0.06);
            --radius: 8px;
            --radius-sm: 7px;
            --header-h: 46px;
        }

        html[data-theme="dark"] {
            --bg: #0b0d12;
            --panel: #121623;
            --border: #2a3147;
            --text: #e6e8ef;
            --muted: #9aa3b2;

            --add-bg: rgba(46, 160, 67, 0.35);
            --del-bg: rgba(248, 81, 73, 0.35);
            --add-bd: rgba(46, 160, 67, 0.85);
            --del-bd: rgba(248, 81, 73, 0.85);
            --same-bg: transparent;

            --guide: rgba(255, 255, 255, 0.06);

            --focus: rgba(120, 160, 255, 0.28);
            --accent: #7aa0ff;

            --shadow: 0 1px 0 rgba(0, 0, 0, 0.35), 0 12px 28px rgba(0, 0, 0, 0.35);
        }

        html[data-theme="light"] {
            color-scheme: light;
        }

        html[data-theme="dark"] {
            color-scheme: dark;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
                "Hiragino Kaku Gothic ProN", "Noto Sans JP", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        header {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            background: var(--panel);
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            min-height: var(--header-h);
            box-shadow: 0 1px 0 rgba(17, 24, 39, 0.02);
        }

        header .title {
            font-weight: 800;
            letter-spacing: 0.3px;
            font-size: 14px;
        }

        header .controls {
            margin-left: auto;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            color: var(--muted);
            font-size: 13px;
        }

        .app-desc {
            padding: 6px 14px 10px;
            font-size: 12px;
            color: var(--muted);
            opacity: 0.95;
        }

        .controls label {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .controls select,
        .controls button {
            appearance: none;
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: var(--radius-sm);
            padding: 7px 10px;
            font-size: 13px;
            line-height: 1;
            height: 32px;
        }

        .controls select {
            padding-right: 28px;
            background-image:
                linear-gradient(45deg, transparent 50%, var(--muted) 50%),
                linear-gradient(135deg, var(--muted) 50%, transparent 50%),
                linear-gradient(to right, transparent, transparent);
            background-position:
                calc(100% - 16px) 13px,
                calc(100% - 11px) 13px,
                0 0;
            background-size: 5px 5px, 5px 5px, 100% 100%;
            background-repeat: no-repeat;
        }

        .controls button {
            cursor: pointer;
            transition: transform 60ms ease, border-color 120ms ease, background 120ms ease;
        }

        .controls button:hover {
            border-color: color-mix(in oklab, var(--border), var(--text) 22%);
            background: color-mix(in oklab, var(--panel), var(--text) 3%);
        }

        .controls button:active {
            transform: translateY(1px);
        }

        .controls select:focus-visible,
        .controls button:focus-visible,
        .input:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .wrap {
            padding: 12px 14px 16px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .col {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            min-height: 60vh;
            display: flex;
            flex-direction: column;
        }

        /* ===== Editor ===== */
        .editor {
            display: grid;
            grid-template-columns: 44px 1fr;
            position: relative;
        }

        .lines {
            padding: 12px 6px 14px;
            border-right: 1px solid var(--border);
            text-align: right;

            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 13px;
            line-height: 1.55;

            color: var(--muted);
            user-select: none;
            white-space: pre;

            background: color-mix(in oklab, var(--panel), var(--text) 1%);
            opacity: 0.9;

            /* scroll sync */
            overflow: hidden;
        }

        html[data-theme="dark"] .lines {
            opacity: 0.75;
        }

        .lines span {
            display: block;
            line-height: 1.55em;
        }

        /* IMPORTANT: overlay container must be grid so grid-area works */
        .pane {
            display: grid;
            position: relative;
            min-width: 0;
            /* allow horizontal scroll inside */
        }

        .highlight,
        .input {
            grid-area: 1 / 1;
            margin: 0;
            padding: 12px 12px 14px;
            border: 0;
            border-radius: 0;
            width: 100%;

            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                "Liberation Mono", "Courier New", monospace;
            font-size: 13px;
            line-height: 1.55;
            tab-size: 4;
            white-space: pre;

            overflow-y: hidden;
            overflow-x: auto;

            background: transparent;
            min-height: 60vh;
        }

        .highlight {
            color: var(--text);
            pointer-events: none;
            z-index: 0;
            background:
                linear-gradient(transparent 30px,
                    var(--guide) 31px,
                    transparent 32px) 0 0 / 100% 1.55em repeat-y;
        }

        .input {
            color: transparent;
            caret-color: var(--text);
            outline: none;
            resize: none;
            z-index: 1;
        }

        .input::selection {
            background: var(--focus);
        }

        .same {
            background: var(--same-bg);
        }

        .add {
            background: var(--add-bg);
            box-shadow: inset 2px 0 0 var(--add-bd);
        }

        .del {
            background: var(--del-bg);
            box-shadow: inset 2px 0 0 var(--del-bd);
        }

        .footer {
            padding: 10px 14px 14px;
            font-size: 12px;
            color: var(--muted);
        }

        .footer a {
            color: var(--muted);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 980px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .col {
                min-height: 40vh;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="title">webdiff</div>

        <div class="controls">
            <label title="Auto は OS（ライト/ダーク）に追従します">
                <select id="theme">
                    <option value="auto" selected>Auto</option>
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                </select>
            </label>

            <label title="CRLF/LFを統一して比較します">
                <input type="checkbox" id="normalizeEol" checked />
                改行を正規化
            </label>

            <label title="スペースやタブが連続している部分を1つにまとめて比較します">
                <input type="checkbox" id="coalesceSpaces" />
                連続空白をまとめる
            </label>

            <button id="clear">両方クリア</button>
        </div>
    </header>

    <div class="app-desc">2つのテキストを貼り付けて差分を比較（文字単位）</div>

    <div class="wrap">
        <div class="grid">
            <section class="col">
                <div class="editor">
                    <div class="lines" id="ln-left"></div>
                    <div class="pane">
                        <pre class="highlight" id="hl-left"></pre>
                        <textarea class="input" id="in-left" spellcheck="false" autocomplete="off"
                            autocapitalize="off"></textarea>
                    </div>
                </div>
            </section>

            <section class="col">
                <div class="editor">
                    <div class="lines" id="ln-right"></div>
                    <div class="pane">
                        <pre class="highlight" id="hl-right"></pre>
                        <textarea class="input" id="in-right" spellcheck="false" autocomplete="off"
                            autocapitalize="off"></textarea>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <footer class="footer">
        <a href="https://github.com/notegridx/webdiff" target="_blank" rel="noopener">
            GitHub: notegridx/webdiff
        </a>
    </footer>

    <script>
        // ===== Theme (Auto / Light / Dark) =====
        const THEME_KEY = 'webdiff:theme'; // 'auto' | 'light' | 'dark'
        const themeSelect = document.getElementById('theme');
        const mql = window.matchMedia('(prefers-color-scheme: dark)');

        function applyTheme(mode) {
            const html = document.documentElement;
            if (mode === 'light') html.setAttribute('data-theme', 'light');
            else if (mode === 'dark') html.setAttribute('data-theme', 'dark');
            else html.setAttribute('data-theme', mql.matches ? 'dark' : 'light');
        }

        function loadTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            const mode = (saved === 'light' || saved === 'dark' || saved === 'auto') ? saved : 'auto';
            themeSelect.value = mode;
            applyTheme(mode);
        }

        function saveTheme(mode) {
            localStorage.setItem(THEME_KEY, mode);
            applyTheme(mode);
        }

        mql.addEventListener('change', () => {
            if (themeSelect.value === 'auto') applyTheme('auto');
        });
        themeSelect.addEventListener('change', () => saveTheme(themeSelect.value));
        loadTheme();

        // ===== Diff App (Chars only) =====
        const inLeft = document.getElementById('in-left');
        const inRight = document.getElementById('in-right');
        const hlLeft = document.getElementById('hl-left');
        const hlRight = document.getElementById('hl-right');
        const lnLeft = document.getElementById('ln-left');
        const lnRight = document.getElementById('ln-right');

        const normalizeEol = document.getElementById('normalizeEol');
        const coalesceSpaces = document.getElementById('coalesceSpaces');
        const clearBtn = document.getElementById('clear');

        const TAB_SIZE = 4;

        function escapeHtml(s) {
            return s
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function preprocess(text) {
            let t = text ?? '';
            if (normalizeEol.checked) t = t.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            if (coalesceSpaces.checked) t = t.replace(/[ \t]+/g, ' ');
            return t;
        }

        function chunkToHtmlPreserveIndent(chunk) {
            let s = escapeHtml(chunk);
            s = s.replace(/\t/g, ' '.repeat(TAB_SIZE));
            s = s.replace(/(^|<br>)( +)/g, (m, p1, p2) => p1 + p2.replace(/ /g, '&nbsp;'));
            s = s.replace(/\n/g, '<br>');
            if (s.endsWith('<br>')) s += '&nbsp;';
            if (s.length === 0) s = '&nbsp;';
            return s;
        }

        function renderFromParts(parts, side) {
            let html = '';

            for (const p of parts) {
                const isAdd = !!p.added;
                const isDel = !!p.removed;

                if (side === 'left' && isAdd) continue;
                if (side === 'right' && isDel) continue;

                const cls = isAdd ? 'add' : isDel ? 'del' : 'same';
                const body = chunkToHtmlPreserveIndent(p.value ?? '');
                html += `<span class="${cls}">${body}</span>`;
            }
            return html || '<span class="same">&nbsp;</span>';
        }

        function autoGrow(inputEl, highlightEl, linesEl) {
            inputEl.style.height = 'auto';
            const h = inputEl.scrollHeight;
            inputEl.style.height = h + 'px';
            highlightEl.style.height = h + 'px';
            linesEl.style.height = h + 'px';
        }

        function buildLineNumbers(text) {
            const lines = text.split('\n').length;
            let html = '';
            for (let i = 1; i <= lines; i++) html += `<span>${i}</span>`;
            return html;
        }

        function syncScroll(input, highlight, lines) {
            highlight.scrollTop = input.scrollTop;
            highlight.scrollLeft = input.scrollLeft;
            lines.scrollTop = input.scrollTop;
        }

        // ---- Diff + Render (debounced, IME-safe) ----
        let timer = null;
        let composing = false;

        function scheduleUpdate() {
            if (composing) return;
            clearTimeout(timer);
            timer = setTimeout(updateDiff, 120);
        }

        function updateDiff() {
            const left = preprocess(inLeft.value);
            const right = preprocess(inRight.value);

            lnLeft.innerHTML = buildLineNumbers(left);
            lnRight.innerHTML = buildLineNumbers(right);

            const parts = Diff.diffChars(left, right);

            hlLeft.innerHTML = renderFromParts(parts, 'left');
            hlRight.innerHTML = renderFromParts(parts, 'right');

            autoGrow(inLeft, hlLeft, lnLeft);
            autoGrow(inRight, hlRight, lnRight);

            syncScroll(inLeft, hlLeft, lnLeft);
            syncScroll(inRight, hlRight, lnRight);
        }

        inLeft.addEventListener('scroll', () => syncScroll(inLeft, hlLeft, lnLeft));
        inRight.addEventListener('scroll', () => syncScroll(inRight, hlRight, lnRight));

        for (const el of [inLeft, inRight]) {
            el.addEventListener('input', scheduleUpdate);
            el.addEventListener('paste', scheduleUpdate);
            el.addEventListener('compositionstart', () => { composing = true; });
            el.addEventListener('compositionend', () => { composing = false; scheduleUpdate(); });
        }

        normalizeEol.addEventListener('change', scheduleUpdate);
        coalesceSpaces.addEventListener('change', scheduleUpdate);

        clearBtn.addEventListener('click', () => {
            inLeft.value = '';
            inRight.value = '';
            scheduleUpdate();
            inLeft.focus();
        });

        // click editor area -> focus textarea (still works with line-number lane)
        for (const editor of document.querySelectorAll('.editor')) {
            editor.addEventListener('pointerdown', (e) => {
                if (e.target?.classList?.contains('input')) return;
                const ta = editor.querySelector('.input');
                if (!ta) return;
                try { if (document.activeElement !== ta) ta.focus({ preventScroll: true }); }
                catch { ta.focus(); }
            });
        }

        updateDiff();
    </script>
</body>

</html>
